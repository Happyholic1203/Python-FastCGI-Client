#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import urlparse

from FastCGIProto import FastCGIProto


def usage():
    print('Usage: %s http://host:port/path?query /document/root [content]' %
          sys.argv[0])
    print('')
    print('Ex. %s http://127.0.0.1:9000/x.php?a=b /var/www' % sys.argv[0])

if __name__ == "__main__":
    if len(sys.argv) not in (3, 4):
        usage()
        sys.exit(1)

    request = sys.argv[1]
    documentRoot = sys.argv[2]
    content = sys.argv[3] if len(sys.argv) == 4 else ''

    parts = urlparse.urlparse(request)
    host = parts.hostname
    port = parts.port
    uri = parts.path
    query = parts.query

    params = {
        'GATEWAY_INTERFACE': 'FastCGI/1.0',
        'REQUEST_METHOD': 'POST',
        'SCRIPT_FILENAME': documentRoot + uri,
        # 'SCRIPT_NAME': uri,
        # 'QUERY_STRING': query,
        # 'REQUEST_URI': uri,
        # 'DOCUMENT_ROOT': documentRoot,
        # 'SERVER_SOFTWARE': 'php/fcgiclient',
        # 'REMOTE_ADDR': '127.0.0.1',
        # 'REMOTE_PORT': '9985',
        # 'SERVER_ADDR': '127.0.0.1',
        # 'SERVER_PORT': '80',
        # 'SERVER_NAME': "localhost",
        # 'SERVER_PROTOCOL': 'HTTP/1.1',
        # 'CONTENT_TYPE': 'application/x-www-form-urlencoded',
        'CONTENT_LENGTH': len(content),
        'PHP_ADMIN_VALUE': 'allow_url_include = On',
        'PHP_VALUE': 'auto_prepend_file = php://input'
    }
    fcgi_proto = FastCGIProto(host, port)
    print(fcgi_proto.gen_request(params, content))
